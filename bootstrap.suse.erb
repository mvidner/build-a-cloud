#!/bin/bash
set -e

reponame() {
    release=$(cat /etc/SuSE-release)
    case "$release" in
        *openSUSE?11.4*)
            echo openSUSE_11.4 ;;
        *openSUSE?12.1*)
            echo openSUSE_12.1 ;;
        *openSUSE?12.2*)
            echo openSUSE_12.2 ;;
        *openSUSE?12.3*)
            echo openSUSE_12.3 ;;
        *"SUSE Linux Enterprise Server"*"VERSION = 11"*"PATCHLEVEL = 1"*)
            echo SLE_11_SP1 ;;
        *"SUSE Linux Enterprise Server"*"VERSION = 11"*"PATCHLEVEL = 2"*)
            echo SLE_11_SP2 ;;
        *"SUSE Linux Enterprise Server"*"VERSION = 11"*"PATCHLEVEL = 3"*)
            echo SLE_11_SP2 ;;
    esac
}

# $1 32 bit id
addrepokey() {
    rpm -qa gpg-pubkey | grep -i $1 && return
    KEYFILE=`mktemp gpg-key-$1-XXXXXX`
    if [ $1 = 0E9AF123 ]; then
        cat > $KEYFILE <<EOF
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v2.0.19 (GNU/Linux)

mQGiBEh7UZcRBACLvGPkYIZVbMpfDmIwQ+Dv1mGuMZ2nRnWZSMfled6W+njVjCXV
ogw1dOeR4guVADsTkkOXPGy9ehfBB0hLxQVVRIuZtsGY+SsqG8QhStmYkbm8hF8w
V0OpVNYSHkkeCRkXba8xNQFtxP+7qqLcCIvsH5kkw5xtS9AgtKVUKARh+wCg90PK
lVsDq3xlQy5Sxm7y1oVTY0UEAIK0Zkh0nVf5oaGeQ5ADXLxqGZHwzrUsX6otKl2M
fAPHLF2d+W2IFCQg3vxok2ON1y0iaaT/lJTx345Eo0PTY7iUJz+lK4u3wvgHk/jN
ZiMzZlRfZ5JKGph2kTw3rgXPc727a2tlGCaR56BtxMhGFs9pQzZt8w5vFVpJ456u
pKNYA/9wyRFS/3gGzMfndM/qst8gJ8pLAa8omAyu4PXyZKcvNmq+YV6t/WXrt/wF
mvEZwZzbPp5dwER6JKLW33N433a/h3ABT2nW1vapa4c78KfOyk3C+eY5mrH9UmhK
nfRAacH6XOnLoDSRjfY2hbHZmeRGvaz237QkXk6ojGZ7x3chGLRKZGV2ZWw6bGFu
Z3VhZ2VzOnJ1YnkgT0JTIFByb2plY3QgPGRldmVsOmxhbmd1YWdlczpydWJ5QGJ1
aWxkLm9wZW5zdXNlLm9yZz6IRgQTEQIABgUCSHtRlwAKCRA7MBG3a51lI9hpAJ98
OuxQHXwXF/P2sdz5ID3oi7nKpgCeJti58rQ/Rdf6HkZjqwUvIYJiKeeIZgQTEQIA
JgUCSHtRlwIbAwUJBB6wAAYLCQgHAwIEFQIIAwQWAgMBAh4BAheAAAoJEJrwyaIO
mvEjPm8AoLCwIVX98fEvQhWzxNJuTQugYV5LAJ0cvgKZaBTyzvQV1zZtDpCoCsUc
bw==
=c0ZI
-----END PGP PUBLIC KEY BLOCK-----
EOF
    else
        gpg --keyserver pgp.mit.edu --recv-keys $1
        gpg --armor --export $1 > $KEYFILE
    fi
    rpm --import $KEYFILE
    rm $KEYFILE
}

addrepo() {
    REPO=$1
    REPOPATH=${REPO//:/:/}  # turn a:b:c into a:/b:/c
    REPOURL=http://192.168.23.1/mirror/download.opensuse.org/repositories/${REPOPATH}/$(reponame)
    REPOKEY=$2

    zypper repos --export - | grep --fixed-strings $REPOURL && return
    addrepokey $REPOKEY
    zypper addrepo $REPOURL ${REPO}
    zypper refresh ${REPO}
}

# $1 obs:repo:name
addobsvendor() {
    VENDORBASE=${1%%:*}
    VENDORID=obs://build.opensuse.org/$VENDORBASE
    VDIR=/etc/zypp/vendors.d
    mkdir -p $VDIR
    test -f $VDIR/$VENDORBASE && return
    cat <<EOF > $VDIR/$VENDORBASE
[main]
vendors = SUSE,$VENDORID
EOF
}

install() {
    zypper --non-interactive install rubygem-chef rubygem-treetop
}

rpm -q rubygem-chef && exit

install && exit

addrepo devel:languages:ruby:extensions 0E9AF123
install && exit

addobsvendor devel:languages:ruby:extensions
install
